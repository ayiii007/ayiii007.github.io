<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Snake Game</title>
<style>
  body {
    margin:0; background: #222; display:flex; flex-direction: column; align-items:center; color:#eee;
    font-family: 'Arial', sans-serif;
    user-select:none;
  }
  canvas {
    background: #fff;
    margin-top: 10px;
    border: 2px solid #555;
  }
  #overlay, #gameover {
    position: fixed; top:0; left:0; width:100vw; height:100vh;
    background: rgba(0,0,0,0.8);
    display: flex; justify-content: center; align-items: center;
    z-index: 10; flex-direction: column;
    color: #eee;
  }
  #overlay > div, #gameover > div {
    background: #333; padding: 20px 30px; border-radius: 12px; text-align:center;
  }
  button {
    margin: 8px 12px;
    padding: 10px 18px;
    font-size: 16px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.3s;
  }
  button:hover {
    background-color: #f0a500;
    color: black;
  }
  h1, h2 {
    margin: 8px 0;
  }
</style>
</head>
<body>

<h1>Snake Game</h1>
<canvas id="game" width="420" height="420"></canvas>

<!-- éš¾åº¦é€‰æ‹©å¼¹çª— -->
<div id="overlay">
  <div>
    <h2>Select Difficulty</h2>
    <button data-speed="140" data-monsters="7" data-reverse="false">Easy</button>
    <button data-speed="60" data-monsters="9" data-reverse="false">Moderate</button>
    <button data-speed="30" data-monsters="11" data-reverse="false">Difficult</button>
    <button data-speed="90" data-monsters="14" data-reverse="true" style="background:black;color:white;">Hell (Reverse)</button>
    <p style="margin-top:15px; font-size:0.9em; color:#ccc;">Use WASD keys to move the snake</p>
  </div>
</div>

<!-- æ¸¸æˆç»“æŸå¼¹çª— -->
<div id="gameover" style="display:none;">
  <div>
    <h2>Game Over</h2>
    <p id="gameover-msg">Your snake died!</p>
    <button id="restart-btn" style="background:green; color:white;">Try Again</button>
    <button id="stop-btn" style="background:red; color:white;">Stop</button>
  </div>
</div>

<script>
(() => {
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const blockSize = 10;
  const widthBlocks = canvas.width / blockSize;
  const heightBlocks = canvas.height / blockSize;
  const wallThickness = 1; // å¢™çš„åšåº¦ä¸º1ä¸ªæ–¹å—

  let snake = [];
  let apple = {x:0, y:0};
  let monsters = [];
  let dx = 0, dy = 1; // åˆå§‹å‘ä¸‹ï¼ˆå› ä¸ºyè½´æ­£æ–¹å‘å‘ä¸‹ï¼‰
  let speed = 60;
  let reverse = false;
  let timerId = null;

  const overlay = document.getElementById('overlay');
  const gameoverDiv = document.getElementById('gameover');
  const restartBtn = document.getElementById('restart-btn');
  const stopBtn = document.getElementById('stop-btn');

  // åˆå§‹åŒ–è›‡ä½ç½®ï¼Œå¤´æ˜¯æ•°ç»„æœ€åä¸€ä¸ªå…ƒç´ 
  function initSnake() {
    snake = [];
    // åˆå§‹ä½ç½®æ”¾åœ¨ä¸­é—´åŒºåŸŸï¼Œè¿œç¦»è¾¹ç•Œ
    const startX = Math.floor(widthBlocks / 2);
    const startY = Math.floor(heightBlocks / 2);
    for(let i=5; i>=0; i--) {
      snake.push({x: startX - i, y: startY});
    }
  }

  // ç”Ÿæˆæ€ªç‰©éšæœºåæ ‡ï¼Œç¡®ä¿ä¸åœ¨å¢™å†…
  function initMonsters(num) {
    monsters = [];
    while(monsters.length < num) {
      const mx = randInt(wallThickness, widthBlocks - wallThickness - 1);
      const my = randInt(wallThickness, heightBlocks - wallThickness - 1);
      if (!isOccupied(mx, my)) {
        monsters.push({x: mx, y: my});
      }
    }
  }

  // åˆ¤æ–­æŸæ ¼æ˜¯å¦è¢«è›‡æˆ–æ€ªç‰©å ç”¨
  function isOccupied(x, y) {
    return snake.some(p => p.x === x && p.y === y) || monsters.some(m => m.x === x && m.y === y);
  }

  // ç”Ÿæˆè‹¹æœéšæœºåæ ‡ï¼Œä¸”ä¸ä¸æ€ªç‰©é‡å ï¼Œä¹Ÿä¸åœ¨å¢™å†…
  function placeApple() {
    do {
      apple.x = randInt(wallThickness, widthBlocks - wallThickness - 1);
      apple.y = randInt(wallThickness, heightBlocks - wallThickness - 1);
    } while (monsters.some(m => m.x === apple.x && m.y === apple.y) || snake.some(s => s.x === apple.x && s.y === apple.y));
  }

  // éšæœºæ•´æ•°[min, max]
  function randInt(min, max) {
    return Math.floor(Math.random()*(max - min + 1)) + min;
  }

  // ç”»èƒŒæ™¯
  function drawBackground() {
    ctx.fillStyle = 'black';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = 'white';
    // ç»˜åˆ¶æ¸¸æˆåŒºåŸŸï¼Œç•™å‡ºå¢™çš„åšåº¦
    ctx.fillRect(
      wallThickness * blockSize, 
      wallThickness * blockSize, 
      canvas.width - 2 * wallThickness * blockSize, 
      canvas.height - 2 * wallThickness * blockSize
    );
  }

  // ç”»æ–¹å—ï¼Œå·¦ä¸Šè§’åæ ‡
  function drawSquare(x, y, color) {
    ctx.fillStyle = color;
    ctx.fillRect(x*blockSize, y*blockSize, blockSize, blockSize);
  }

  // ç”»è›‡ï¼ˆè“è‰²æ–¹å—ï¼‰
  function drawSnake() {
    snake.forEach(part => {
      drawSquare(part.x, part.y, 'blue');
    });
  }

  // ç”»è‹¹æœï¼ˆemojiï¼‰
  function drawApple() {
    ctx.font = '18px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('ğŸ', apple.x * blockSize + blockSize/2, apple.y * blockSize + blockSize/2 + 2);
  }

  // ç”»æ€ªç‰©ï¼ˆemojiï¼‰
  function drawMonsters() {
    ctx.font = '20px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    monsters.forEach(m => {
      ctx.fillText('ğŸ‘¾', m.x * blockSize + blockSize/2, m.y * blockSize + blockSize/2 + 2);
    });
  }

  // æ¸¸æˆç»“æŸæ˜¾ç¤ºä¿¡æ¯
  function showGameOver() {
    gameoverDiv.style.display = 'flex';
  }

  // éšè—æ¸¸æˆç»“æŸå¼¹çª—
  function hideGameOver() {
    gameoverDiv.style.display = 'none';
  }

  // æ¸¸æˆä¸»å¾ªç¯
  function gameLoop() {
    // æ–°å¤´åæ ‡
    const head = snake[snake.length - 1];
    const newHead = {x: head.x + dx, y: head.y + dy};

    // æ’å¢™æ£€æµ‹ï¼ˆè¾¹ç•Œä¸èƒ½è¶…è¿‡å¢™çš„åšåº¦ï¼‰
    if(newHead.x < wallThickness || newHead.x >= widthBlocks - wallThickness || 
       newHead.y < wallThickness || newHead.y >= heightBlocks - wallThickness) {
      endGame();
      return;
    }

    // æ’è‡ªå·±æ£€æµ‹
    if(snake.some(p => p.x === newHead.x && p.y === newHead.y)) {
      endGame();
      return;
    }

    // æ’æ€ªç‰©æ£€æµ‹
    if(monsters.some(m => m.x === newHead.x && m.y === newHead.y)) {
      endGame();
      return;
    }

    snake.push(newHead);

    // åƒè‹¹æœé€»è¾‘
    if(newHead.x === apple.x && newHead.y === apple.y) {
      placeApple(); // ç”Ÿæˆæ–°è‹¹æœ
    } else {
      snake.shift(); // ä¸åƒè‹¹æœå»å°¾
    }

    // ç»˜åˆ¶
    drawBackground();
    drawApple();
    drawSnake();
    drawMonsters();

    timerId = setTimeout(gameLoop, speed);
  }

  // ç»“æŸæ¸¸æˆ
  function endGame() {
    clearTimeout(timerId);
    showGameOver();
  }

  // åˆå§‹åŒ–å¹¶å¼€å§‹æ¸¸æˆ
  function startGame(chosenSpeed, monsterCount, isReverse) {
    speed = chosenSpeed;
    reverse = isReverse;

    dx = 0;
    dy = 1;
    initSnake();
    initMonsters(monsterCount);
    placeApple();
    hideGameOver();
    drawBackground();
    drawApple();
    drawSnake();
    drawMonsters();

    if(timerId) clearTimeout(timerId);
    timerId = setTimeout(gameLoop, speed);
  }

  // æŒ‰é”®å¤„ç†ï¼Œæ ¹æ®æ˜¯å¦åè½¬æ˜ å°„WASDé”®
  function handleKeyDown(e) {
    const key = e.key.toLowerCase();
    // æ­£å¸¸æ˜ å°„
    const normalMapping = {
      w: [0, -1],
      s: [0, 1],
      a: [-1, 0],
      d: [1, 0],
    };
    // åè½¬æ˜ å°„
    const reverseMapping = {
      w: [0, 1],
      s: [0, -1],
      a: [1, 0],
      d: [-1, 0],
    };

    let mapping = reverse ? reverseMapping : normalMapping;

    if(key in mapping) {
      const [newDx, newDy] = mapping[key];
      // ç¦æ­¢180åº¦è½¬å‘
      if(dx !== -newDx || dy !== -newDy) {
        dx = newDx;
        dy = newDy;
      }
    }
  }

  // ç»‘å®šéš¾åº¦æŒ‰é’®äº‹ä»¶
  overlay.querySelectorAll('button').forEach(btn => {
    btn.addEventListener('click', () => {
      const spd = parseInt(btn.getAttribute('data-speed'));
      const mons = parseInt(btn.getAttribute('data-monsters'));
      const rev = btn.getAttribute('data-reverse') === 'true';
      overlay.style.display = 'none';
      startGame(spd, mons, rev);
    });
  });

  // æ¸¸æˆç»“æŸæŒ‰é’®äº‹ä»¶
  restartBtn.onclick = () => {
    overlay.style.display = 'none';
    hideGameOver();
    startGame(speed, monsters.length, reverse);
  };
  stopBtn.onclick = () => {
    hideGameOver();
    overlay.style.display = 'flex';
  };

  // ç›‘å¬é”®ç›˜äº‹ä»¶
  window.addEventListener('keydown', handleKeyDown);

  // æç¤º
  ctx.font = '20px Arial';
  ctx.fillStyle = 'white';
  ctx.textAlign = 'center';
  ctx.fillText('Select difficulty to start', canvas.width/2, canvas.height/2);
})();
</script>

</body>
</html>